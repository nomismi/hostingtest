<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ ìº¡ì…˜ ê²€ìˆ˜ ë„êµ¬</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.2em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }

        .control-group label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }

        select, input[type="file"] {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .load-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            align-self: flex-end;
        }

        .load-btn:hover {
            transform: translateY(-2px);
        }

        .progress-info {
            background: white;
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 0 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            width: 0%;
            transition: width 0.3s ease;
        }

        .reviewer-info {
            color: #4a5568;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clickable-name {
            cursor: pointer;
            border-bottom: 1px dashed #4a5568;
            transition: all 0.3s ease;
        }

        .clickable-name:hover {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .change-name-btn {
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            color: #4a5568;
            transition: all 0.3s ease;
        }

        .change-name-btn:hover {
            background: #f8fafc;
            border-color: #667eea;
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: 600px;
        }

        .left-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .image-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 400px;
        }

        .image-container.has-image {
            border: none;
            padding: 0;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .placeholder-text {
            color: #a0aec0;
            font-size: 1.1em;
            text-align: center;
        }

        .caption-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .caption-section h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .caption-text {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-size: 14px;
            line-height: 1.6;
            color: #2d3748;
            min-height: 80px;
        }

        .right-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .feedback-form h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .evaluation-section {
            margin-bottom: 25px;
        }

        .evaluation-section h4 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .quality-check {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-option:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .checkbox-option.selected {
            border-color: #48bb78;
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(56, 161, 105, 0.1));
        }

        .checkbox-option input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-option label {
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
        }

        .comment-section textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .comment-section textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            margin-top: auto;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .save-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .save-btn:hover {
            transform: translateY(-2px);
        }

        .export-btn {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
        }

        .save-status {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .save-status.success {
            background: #c6f6d5;
            color: #276749;
        }

        .save-status.error {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .name-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .name-modal-content h2 {
            color: #4a5568;
            margin-bottom: 25px;
            font-size: 1.5em;
        }

        .name-modal-content input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 25px;
            text-align: center;
            box-sizing: border-box;
        }

        .name-modal-content input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .name-modal-content button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .name-modal-content button:hover {
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        /* Navigation Controls */
        .navigation-controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-image-info {
            font-weight: 600;
            color: #4a5568;
            font-size: 1.1em;
        }

        .excel-btn {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 14px;
        }

        .excel-btn:hover {
            transform: translateY(-2px);
        }

        .excel-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .nav-center {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 14px;
            min-width: 100px;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .nav-btn#list-btn {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .right-panel {
                order: -1;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                min-width: auto;
            }
            
            .navigation-controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .nav-left, .nav-center {
                justify-content: center;
            }
            
            .nav-center {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Name Input Modal -->
    <div class="modal-overlay hidden" id="name-input-modal">
        <div class="name-modal-content">
            <h2>ğŸ™‹ ê²€í† ì ì •ë³´ ì…ë ¥</h2>
            <input type="text" id="reviewer-name-input" placeholder="ì˜ˆ: í™ê¸¸ë™" autofocus>
            <button id="start-review-btn">âœ… ê²€í†  ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ–¼ï¸ ì´ë¯¸ì§€ ìº¡ì…˜ ê²€ìˆ˜ ë„êµ¬</h1>
            <p>ì´ë¯¸ì§€ì™€ ìº¡ì…˜ì˜ ì •í™•ì„±ì„ ê²€í† í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="folder-input">ğŸ“ ë°ì´í„° í´ë” ì„ íƒ</label>
                <input type="file" id="folder-input" webkitdirectory directory multiple title="ë°ì´í„° í´ë” ì„ íƒ" aria-label="ë°ì´í„° í´ë” ì„ íƒ">
            </div>
            <div class="control-group">
                <label for="project-select">ğŸ“‚ í”„ë¡œì íŠ¸ ì„ íƒ</label>
                <select id="project-select" disabled>
                    <option value="">ë¨¼ì € í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <button class="load-btn" id="load-data-btn" disabled>ğŸ“‹ ë°ì´í„° ë¡œë“œ</button>
        </div>

        <!-- Progress Info -->
        <div class="progress-info">
            <div class="reviewer-info">
                <span>ğŸ‘¤ ê²€í† ì: <span id="reviewer-name-display" class="clickable-name" title="í´ë¦­í•˜ì—¬ ì´ë¦„ ë³€ê²½">-</span></span>
                <button class="change-name-btn" id="change-name-btn" title="ê²€í† ì ì´ë¦„ ë³€ê²½">âœï¸</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="progress-text">0 / 0 ì™„ë£Œ (0%)</span>
            </div>
        </div>

        <!-- Navigation Controls -->
        <div class="navigation-controls" id="navigation-controls" style="display: none;">
            <div class="nav-left">
                <span class="current-image-info" id="current-image-info">ì´ë¯¸ì§€ ì •ë³´</span>
                <button class="excel-btn" id="open-excel-btn">ğŸ“Š ì›ë³¸ ê°œë°œ ìë£Œ ì—´ê¸°</button>
            </div>
            <div class="nav-center">
                <button class="nav-btn" id="prev-btn" disabled>â¬…ï¸ ì´ì „</button>
                <button class="nav-btn" id="list-btn">ğŸ“‹ ëª©ë¡</button>
                <button class="nav-btn" id="next-btn" disabled>ë‹¤ìŒ â¡ï¸</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Image and Caption -->
            <div class="left-panel">
                <div class="image-container" id="image-container">
                    <div class="placeholder-text">
                        <p>ğŸ–¼ï¸ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                        <p>ë¨¼ì € ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                    </div>
                </div>

                <div class="caption-section">
                    <h3>ğŸ“ ì´ë¯¸ì§€ ìº¡ì…˜</h3>
                    <div class="caption-text" id="caption-text">
                        ìº¡ì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                    </div>
                </div>
            </div>

            <!-- Right Panel - Feedback Form -->
            <div class="right-panel">
                <div class="feedback-form">
                    <h3>ğŸ“‹ ìº¡ì…˜ ê²€ìˆ˜</h3>

                    <div class="evaluation-section">
                        <div class="quality-check">
                            <div class="checkbox-option">
                                <input type="checkbox" id="no-issues" name="quality-check">
                                <label for="no-issues">âœ… í’ˆì§ˆ ë¬¸ì œ ì—†ìŒ (ìº¡ì…˜ì´ ì™„ë²½í•¨)</label>
                            </div>
                        </div>
                    </div>

                    <div class="comment-section">
                        <h4>ìº¡ì…˜ ìˆ˜ì • ë° ë³´ì™„ ì œì•ˆ</h4>
                        <textarea id="feedback-comment" placeholder="ì´ë¯¸ì§€ ìº¡ì…˜ì— ëŒ€í•œ ì •ë³´ë¥¼ ì¶”ê°€ ë³´ì™„, ìˆ˜ì • ë“±ì„ í¬í•¨í•˜ì—¬ ì´ë¯¸ì§€ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ê¸°ì¡´ ìº¡ì…˜ì„ ì°¸ê³ í•˜ì—¬ ë” ì •í™•í•˜ê³  ì™„ì„±ë„ ë†’ì€ ìº¡ì…˜ìœ¼ë¡œ ìƒˆë¡­ê²Œ ì‘ì„±í•˜ì‹œê±°ë‚˜ í•„ìš”í•œ ìˆ˜ì •ì‚¬í•­ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”."></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="save-btn" id="save-feedback-btn">ğŸ’¾ í”¼ë“œë°± ì €ì¥</button>
                        <button class="export-btn" id="export-results-btn">ğŸ“¤ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
                        <div class="save-status hidden" id="save-status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ImageCaptionReviewer {
            constructor() {
                this.reviewerName = '';
                this.projects = new Map();
                this.currentProject = '';
                this.currentImage = '';
                this.currentImageList = [];
                this.currentImageIndex = -1;
                this.feedbackData = new Map();
                this.init();
            }

            init() {
                this.checkReviewerName();
                this.bindEvents();
                this.loadSavedData();
            }

            checkReviewerName() {
                const savedName = localStorage.getItem('reviewer_name_images');
                if (savedName) {
                    this.reviewerName = savedName;
                    document.getElementById('reviewer-name-display').textContent = savedName;
                } else {
                    this.showNameInputModal();
                }
            }

            showNameInputModal() {
                const modal = document.getElementById('name-input-modal');
                modal.classList.remove('hidden');
                
                const nameInput = document.getElementById('reviewer-name-input');
                const startBtn = document.getElementById('start-review-btn');

                startBtn.onclick = () => {
                    const name = nameInput.value.trim();
                    if (name) {
                        this.saveReviewerName(name);
                        modal.classList.add('hidden');
                    } else {
                        alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        nameInput.focus();
                    }
                };

                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        startBtn.click();
                    }
                });
            }

            saveReviewerName(name) {
                this.reviewerName = name;
                localStorage.setItem('reviewer_name_images', name);
                document.getElementById('reviewer-name-display').textContent = name;
            }

            changeReviewerName() {
                const currentName = this.reviewerName;
                const newName = prompt('ê²€í† ì ì´ë¦„ì„ ë³€ê²½í•˜ì„¸ìš”:', currentName);
                
                if (newName && newName.trim() && newName.trim() !== currentName) {
                    const confirmChange = confirm(`ê²€í† ì ì´ë¦„ì„ "${currentName}"ì—ì„œ "${newName.trim()}"ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ì˜: ì´ë¯¸ ì €ì¥ëœ í”¼ë“œë°±ì˜ ê²€í† ì ì´ë¦„ë„ ëª¨ë‘ ë³€ê²½ë©ë‹ˆë‹¤.`);
                    
                    if (confirmChange) {
                        const oldName = this.reviewerName;
                        const trimmedNewName = newName.trim();
                        
                        // í˜„ì¬ ê²€í† ì ì´ë¦„ ë³€ê²½
                        this.saveReviewerName(trimmedNewName);
                        
                        // ê¸°ì¡´ í”¼ë“œë°± ë°ì´í„°ì˜ ê²€í† ì ì´ë¦„ë„ ì¼ê´„ ë³€ê²½
                        this.updateExistingFeedbackReviewerName(oldName, trimmedNewName);
                        
                        alert(`ê²€í† ì ì´ë¦„ì´ "${trimmedNewName}"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                }
            }

            updateExistingFeedbackReviewerName(oldName, newName) {
                this.feedbackData.forEach((feedback, key) => {
                    if (feedback.reviewer === oldName) {
                        feedback.reviewer = newName;
                    }
                });
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì—…ë°ì´íŠ¸ëœ ë°ì´í„° ì €ì¥
                this.saveToLocalStorage();
            }

            bindEvents() {
                document.getElementById('folder-input').addEventListener('change', (e) => {
                    this.handleFolderSelection(e);
                });

                document.getElementById('project-select').addEventListener('change', (e) => {
                    this.handleProjectSelection(e);
                });

                document.getElementById('load-data-btn').addEventListener('click', () => {
                    this.loadProjectData();
                });

                // Navigation buttons
                document.getElementById('prev-btn').addEventListener('click', () => {
                    this.navigateToPrevious();
                });

                document.getElementById('next-btn').addEventListener('click', () => {
                    this.navigateToNext();
                });

                document.getElementById('list-btn').addEventListener('click', () => {
                    this.showImageList();
                });

                document.getElementById('open-excel-btn').addEventListener('click', () => {
                    this.openExcelFile();
                });

                // Name change handlers
                document.getElementById('reviewer-name-display').addEventListener('click', () => {
                    this.changeReviewerName();
                });

                document.getElementById('change-name-btn').addEventListener('click', () => {
                    this.changeReviewerName();
                });

                document.getElementById('save-feedback-btn').addEventListener('click', () => {
                    this.saveFeedback();
                });

                document.getElementById('export-results-btn').addEventListener('click', () => {
                    this.exportResults();
                });

                // Checkbox option selection
                const checkboxOption = document.querySelector('.checkbox-option');
                checkboxOption.addEventListener('click', () => {
                    const checkbox = checkboxOption.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    this.updateCheckboxSelection();
                });

                // Auto-save on input changes
                document.getElementById('feedback-comment').addEventListener('input', () => {
                    this.autoSave();
                });

                document.getElementById('no-issues').addEventListener('change', () => {
                    this.updateCheckboxSelection();
                    this.autoSave();
                });
            }

            handleFolderSelection(event) {
                const files = Array.from(event.target.files);
                this.projects.clear();

                // Group files by project folder - ìœ ì—°í•œ êµ¬ì¡° ì²˜ë¦¬
                files.forEach(file => {
                    const pathParts = file.webkitRelativePath.split('/');
                    const fileName = pathParts[pathParts.length - 1];
                    
                    // gemma_captions_revised.txt íŒŒì¼ì„ ì°¾ì•„ì„œ í”„ë¡œì íŠ¸ êµ¬ì¡° íŒŒì•…
                    let projectName = '';
                    
                    if (pathParts.length === 2) {
                        // ì§ì ‘ êµ¬ì¡°: í”„ë¡œì íŠ¸1/íŒŒì¼
                        projectName = pathParts[0];
                    } else if (pathParts.length >= 3) {
                        // ì¤‘ì²© êµ¬ì¡°: ì‚¬ìš©ì_ë°ì´í„°/í”„ë¡œì íŠ¸1/íŒŒì¼
                        // gemma_captions_revised.txtê°€ ìˆëŠ” í´ë”ë¥¼ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì¸ì‹
                        if (fileName === 'gemma_captions_revised.txt') {
                            projectName = pathParts[pathParts.length - 2]; // íŒŒì¼ ë°”ë¡œ ìœ„ í´ë”
                        } else {
                            // ë‹¤ë¥¸ íŒŒì¼ë“¤ì€ ê°™ì€ ë ˆë²¨ì—ì„œ gemma_captions_revised.txtë¥¼ ì°¾ì•„ì„œ ë§¤ì¹­
                            const projectFolderIndex = pathParts.length - 2;
                            projectName = pathParts[projectFolderIndex];
                        }
                    }

                    if (projectName) {
                        if (!this.projects.has(projectName)) {
                            this.projects.set(projectName, {
                                images: new Map(),
                                captions: new Map(),
                                captionFile: null,
                                excelFile: null
                            });
                        }

                        const project = this.projects.get(projectName);

                        if (fileName === 'gemma_captions_revised.txt') {
                            project.captionFile = file;
                        } else if (fileName.endsWith('.png')) {
                            const imageKey = fileName.replace('.png', '');
                            project.images.set(imageKey, file);
                        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                            project.excelFile = file;
                        }
                    }
                });

                this.populateProjectSelect();
            }

            populateProjectSelect() {
                const projectSelect = document.getElementById('project-select');
                projectSelect.innerHTML = '<option value="">í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';

                this.projects.forEach((project, projectName) => {
                    const option = document.createElement('option');
                    option.value = projectName;
                    option.textContent = projectName;
                    projectSelect.appendChild(option);
                });

                projectSelect.disabled = false;
            }

            async handleProjectSelection(event) {
                const projectName = event.target.value;
                this.currentProject = projectName;

                if (!projectName) {
                    document.getElementById('load-data-btn').disabled = true;
                    document.getElementById('navigation-controls').style.display = 'none';
                    return;
                }

                const project = this.projects.get(projectName);
                
                // Load captions
                if (project.captionFile) {
                    try {
                        const captionText = await this.readTextFile(project.captionFile);
                        this.parseCaptions(captionText, project);
                    } catch (error) {
                        console.error('ìº¡ì…˜ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                        alert('ìº¡ì…˜ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                }

                // Prepare image list
                this.prepareImageList(project);
                document.getElementById('load-data-btn').disabled = false;
            }

            readTextFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file, 'utf-8');
                });
            }

            parseCaptions(captionText, project) {
                const lines = captionText.split('\n');
                
                lines.forEach(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const fileName = line.substring(0, colonIndex).trim();
                        const caption = line.substring(colonIndex + 1).trim();
                        const imageKey = fileName.replace('.png', '');
                        project.captions.set(imageKey, caption);
                    }
                });
            }

            prepareImageList(project) {
                // Sort image keys naturally
                this.currentImageList = Array.from(project.images.keys()).sort((a, b) => {
                    const aMatch = a.match(/p(\d+)_img(\d+)/);
                    const bMatch = b.match(/p(\d+)_img(\d+)/);
                    
                    if (aMatch && bMatch) {
                        const aPage = parseInt(aMatch[1]);
                        const bPage = parseInt(bMatch[1]);
                        const aImg = parseInt(aMatch[2]);
                        const bImg = parseInt(bMatch[2]);
                        
                        if (aPage !== bPage) return aPage - bPage;
                        return aImg - bImg;
                    }
                    
                    return a.localeCompare(b);
                });
            }

            async loadProjectData() {
                if (!this.currentProject) {
                    alert('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (this.currentImageList.length === 0) {
                    alert('ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // Load first image
                this.currentImageIndex = 0;
                this.currentImage = this.currentImageList[0];
                await this.loadCurrentImage();

                // Show navigation controls
                document.getElementById('navigation-controls').style.display = 'flex';
                this.updateNavigationButtons();
            }

            async loadCurrentImage() {
                if (!this.currentProject || !this.currentImage) {
                    return;
                }

                const project = this.projects.get(this.currentProject);
                const imageFile = project.images.get(this.currentImage);
                const caption = project.captions.get(this.currentImage);

                if (!imageFile) {
                    alert('ì„ íƒí•œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // Display image
                const imageContainer = document.getElementById('image-container');
                imageContainer.innerHTML = '';
                imageContainer.classList.add('has-image');

                const img = document.createElement('img');
                img.className = 'preview-image';
                img.alt = this.currentImage;
                
                const imageUrl = URL.createObjectURL(imageFile);
                img.src = imageUrl;
                
                imageContainer.appendChild(img);

                // Display caption
                const captionText = document.getElementById('caption-text');
                captionText.textContent = caption || 'ìº¡ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

                // Update current image info
                this.updateCurrentImageInfo();

                // Load saved feedback
                this.loadFeedbackForCurrentItem();
                this.updateProgress();
                this.updateNavigationButtons();
            }

            updateCurrentImageInfo() {
                const info = `${this.currentImage}.png (${this.currentImageIndex + 1}/${this.currentImageList.length})`;
                document.getElementById('current-image-info').textContent = info;
            }

            updateNavigationButtons() {
                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');
                const excelBtn = document.getElementById('open-excel-btn');

                prevBtn.disabled = this.currentImageIndex <= 0;
                nextBtn.disabled = this.currentImageIndex >= this.currentImageList.length - 1;
                
                const project = this.projects.get(this.currentProject);
                excelBtn.disabled = !project || !project.excelFile;
            }

            async navigateToPrevious() {
                if (this.currentImageIndex > 0) {
                    this.currentImageIndex--;
                    this.currentImage = this.currentImageList[this.currentImageIndex];
                    await this.loadCurrentImage();
                }
            }

            async navigateToNext() {
                if (this.currentImageIndex < this.currentImageList.length - 1) {
                    this.currentImageIndex++;
                    this.currentImage = this.currentImageList[this.currentImageIndex];
                    await this.loadCurrentImage();
                }
            }

            showImageList() {
                const imageList = this.currentImageList.map((imageKey, index) => {
                    const feedbackKey = `${this.currentProject}::${imageKey}`;
                    const feedback = this.feedbackData.get(feedbackKey);
                    const status = feedback && feedback.completed ? 'âœ…' : 'â³';
                    return `${index + 1}. ${status} ${imageKey}.png`;
                }).join('\n');

                const selectedIndex = prompt(
                    `ì´ë¯¸ì§€ ëª©ë¡:\n\n${imageList}\n\nì´ë™í•  ì´ë¯¸ì§€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-${this.currentImageList.length}):`,
                    (this.currentImageIndex + 1).toString()
                );

                if (selectedIndex) {
                    const index = parseInt(selectedIndex) - 1;
                    if (index >= 0 && index < this.currentImageList.length) {
                        this.currentImageIndex = index;
                        this.currentImage = this.currentImageList[index];
                        this.loadCurrentImage();
                    } else {
                        alert('ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                }
            }

            openExcelFile() {
                const project = this.projects.get(this.currentProject);
                if (!project || !project.excelFile) {
                    alert('ì—‘ì…€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // Create a temporary URL and trigger download
                const url = URL.createObjectURL(project.excelFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = project.excelFile.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            loadFeedbackForCurrentItem() {
                const feedbackKey = `${this.currentProject}::${this.currentImage}`;
                const savedFeedback = this.feedbackData.get(feedbackKey);

                if (savedFeedback) {
                    // Load checkbox
                    document.getElementById('no-issues').checked = savedFeedback.noIssues || false;
                    this.updateCheckboxSelection();

                    // Load comment
                    document.getElementById('feedback-comment').value = savedFeedback.comment || '';
                } else {
                    // Clear form
                    document.getElementById('no-issues').checked = false;
                    document.getElementById('feedback-comment').value = '';
                    this.updateCheckboxSelection();
                }
            }

            updateCheckboxSelection() {
                const checkboxOption = document.querySelector('.checkbox-option');
                const checkbox = checkboxOption.querySelector('input[type="checkbox"]');
                
                if (checkbox.checked) {
                    checkboxOption.classList.add('selected');
                    // í’ˆì§ˆ ë¬¸ì œ ì—†ìŒ ì²´í¬ ì‹œ í…ìŠ¤íŠ¸ ì˜ì—­ ë¹„ìš°ê¸° (ì„ íƒì‚¬í•­)
                    // document.getElementById('feedback-comment').value = '';
                } else {
                    checkboxOption.classList.remove('selected');
                }
            }

            saveFeedback() {
                if (!this.currentProject || !this.currentImage) {
                    this.showSaveStatus('í”„ë¡œì íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                const noIssues = document.getElementById('no-issues').checked;
                const comment = document.getElementById('feedback-comment').value.trim();

                // í”¼ë“œë°± ì™„ë£Œ ê¸°ì¤€: í’ˆì§ˆ ë¬¸ì œ ì—†ìŒ ì²´í¬ OR ìˆ˜ì • ì œì•ˆ ì‘ì„±
                if (!noIssues && !comment) {
                    this.showSaveStatus('í’ˆì§ˆ ë¬¸ì œ ì—†ìŒì„ ì²´í¬í•˜ê±°ë‚˜ ìˆ˜ì • ì œì•ˆì„ ì‘ì„±í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                const feedbackKey = `${this.currentProject}::${this.currentImage}`;
                const feedbackData = {
                    project: this.currentProject,
                    image: this.currentImage,
                    noIssues: noIssues,
                    comment: comment,
                    reviewer: this.reviewerName,
                    timestamp: new Date().toISOString(),
                    completed: true  // ì™„ë£Œ ê¸°ì¤€ ì¶©ì¡±
                };

                this.feedbackData.set(feedbackKey, feedbackData);
                this.saveToLocalStorage();
                this.updateProgress();
                this.showSaveStatus('í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            autoSave() {
                if (!this.currentProject || !this.currentImage) return;

                const noIssues = document.getElementById('no-issues').checked;
                const comment = document.getElementById('feedback-comment').value.trim();

                if (noIssues || comment) {
                    const feedbackKey = `${this.currentProject}::${this.currentImage}`;
                    const feedbackData = {
                        project: this.currentProject,
                        image: this.currentImage,
                        noIssues: noIssues,
                        comment: comment,
                        reviewer: this.reviewerName,
                        timestamp: new Date().toISOString(),
                        completed: noIssues || (comment.length > 0)  // ì™„ë£Œ ê¸°ì¤€
                    };

                    this.feedbackData.set(feedbackKey, feedbackData);
                    this.saveToLocalStorage();
                }
            }

            saveToLocalStorage() {
                const dataToSave = Array.from(this.feedbackData.entries()).map(([key, value]) => [key, value]);
                localStorage.setItem('image_caption_feedback', JSON.stringify(dataToSave));
            }

            loadSavedData() {
                const savedData = localStorage.getItem('image_caption_feedback');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        this.feedbackData = new Map(parsedData);
                    } catch (error) {
                        console.error('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    }
                }
            }

            updateProgress() {
                if (!this.currentProject) return;

                const project = this.projects.get(this.currentProject);
                if (!project) return;

                const totalImages = project.images.size;
                let completedCount = 0;

                project.images.forEach((file, imageKey) => {
                    const feedbackKey = `${this.currentProject}::${imageKey}`;
                    const feedback = this.feedbackData.get(feedbackKey);
                    if (feedback && feedback.completed) {
                        completedCount++;
                    }
                });

                const progressPercent = totalImages > 0 ? Math.round((completedCount / totalImages) * 100) : 0;
                
                document.getElementById('progress-fill').style.width = `${progressPercent}%`;
                document.getElementById('progress-text').textContent = `${completedCount} / ${totalImages} ì™„ë£Œ (${progressPercent}%)`;
            }

            exportResults() {
                if (this.feedbackData.size === 0) {
                    alert('ë‚´ë³´ë‚¼ í”¼ë“œë°± ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const results = {
                    reviewer: this.reviewerName,
                    exportDate: new Date().toISOString(),
                    totalFeedbacks: this.feedbackData.size,
                    feedbacks: Array.from(this.feedbackData.values())
                };

                const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.reviewerName}_image_caption_results_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showSaveStatus('ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'success');
            }

            showSaveStatus(message, type) {
                const statusElement = document.getElementById('save-status');
                statusElement.textContent = message;
                statusElement.className = `save-status ${type}`;
                statusElement.classList.remove('hidden');

                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 3000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new ImageCaptionReviewer();
        });
    </script>
</body>
</html>